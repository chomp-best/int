<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | Eliseo Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; -webkit-font-smoothing: antialiased; }
        .auth-overlay, .modal-overlay { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .modal-overlay { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 90; }
        .glass-card { background: #0a0a0a; border: 1px solid #1c1c1e; border-radius: 1rem; transition: all 0.3s ease; }
        .glass-card:hover { border-color: #333; }
        .input-auth { background: #111; border: 1px solid #222; border-radius: 12px; color: #fff; padding: 14px; width: 220px; text-align: center; letter-spacing: 0.4em; }
        .studio-seal { width: 36px; height: 36px; background: #fff; color: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; margin-bottom: 1rem; }
        .status-btn { flex: 1; padding: 6px; font-size: 7px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); color: #444; }
        .status-btn.active-green { border-color: #22c55e44; color: #22c55e; background: #22c55e0a; }
        .status-btn.active-red { border-color: #ef444444; color: #ef4444; background: #ef44440a; }
        .status-btn.active-gray { border-color: #6b728044; color: #6b7280; background: #6b72800a; }
        .pulse-dot { width: 5px; height: 5px; border-radius: 50%; animation: soft-pulse 2s infinite; }
        @keyframes soft-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); }

        .btn-action { transition: all 0.2s ease; cursor: pointer; }
        .btn-delete { color: #222; }
        .btn-delete:hover { color: #ef4444; transform: scale(1.1); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Auth -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="studio-seal shadow-2xl">e.</div>
        <input type="password" id="pass-input" class="input-auth" placeholder="••••" onkeydown="if(event.key==='Enter') window.checkKey()">
        <button onclick="window.checkKey()" class="w-[220px] py-4 bg-white text-black rounded-xl font-bold text-[10px] uppercase tracking-widest mt-6">Desbloquear</button>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="glass-card p-8 w-full max-w-xs text-center space-y-6">
            <i class="fa-solid fa-triangle-exclamation text-amber-500 text-2xl"></i>
            <div>
                <h3 class="text-md font-bold text-white uppercase tracking-tighter">Confirmar Purga</h3>
                <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest">Esta acción es irreversible.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="window.closeDeleteModal()" class="flex-1 py-3 bg-white/5 rounded-xl text-[9px] font-bold uppercase">Cancelar</button>
                <button id="confirm-delete-btn" class="flex-1 py-3 bg-red-600 text-white rounded-xl text-[9px] font-bold uppercase shadow-lg shadow-red-600/20">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Metrics Modal -->
    <div id="metrics-modal" class="modal-overlay hidden">
        <div class="glass-card p-6 w-full max-w-sm space-y-4">
            <h3 class="text-md font-medium tracking-tight uppercase text-white/50 text-[10px] tracking-[0.2em]">Refinar Activos</h3>
            <div class="space-y-2">
                <input type="number" id="m-visits" class="w-full bg-black border border-[#1c1c1e] p-3 rounded-lg text-xs" placeholder="Visitas">
                <input type="number" id="m-leads" class="w-full bg-black border border-[#1c1c1e] p-3 rounded-lg text-xs" placeholder="Leads">
                <input type="number" id="m-progress" class="w-full bg-black border border-[#1c1c1e] p-3 rounded-lg text-xs" placeholder="Progreso %">
            </div>
            <button id="save-metrics-btn" class="w-full py-4 bg-blue-600 text-white rounded-lg font-bold text-[10px] uppercase tracking-widest">Sincronizar</button>
            <button onclick="window.closeModal()" class="w-full text-[9px] text-gray-700 uppercase tracking-widest">Cerrar</button>
        </div>
    </div>

    <!-- Main -->
    <div id="main-content" class="hidden max-w-6xl mx-auto px-6 py-10">
        <header class="flex flex-col mb-10">
            <div class="studio-seal">e.</div>
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-semibold tracking-tighter">Command Center</h1>
                    <p class="text-[10px] text-gray-600 font-light italic">Gestión Operativa Eliseo Studio.</p>
                </div>
                <div class="flex items-center gap-2">
                    <div class="pulse-dot bg-green-500"></div>
                    <span class="text-[8px] text-gray-700 uppercase font-black tracking-widest">Live</span>
                </div>
            </div>
        </header>

        <section class="mb-12">
            <h2 class="text-md font-medium tracking-tight mb-4 text-white/60 flex justify-between items-center">
                <span class="text-[10px] uppercase tracking-[0.3em]">Proyectos Activos</span>
                <span id="proj-count" class="text-[9px] opacity-20 font-bold uppercase">0</span>
            </h2>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <section>
            <h2 class="text-md font-medium tracking-tight mb-4 text-gray-700 flex justify-between items-center">
                <span class="text-[10px] uppercase tracking-[0.3em]">Bandeja Pulse IA</span>
                <span id="lead-count" class="text-[9px] opacity-20 font-bold uppercase">0</span>
            </h2>
            <div id="leads-list" class="grid grid-cols-1 gap-4"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // SECURITY REINFORCEMENT: Environment Variable Priority
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyAXmYX6D9F8MTd-6TTc5AjOz7DhRy_cWH8",
                authDomain: "eliseo-studio.firebaseapp.com",
                projectId: "eliseo-studio",
                storageBucket: "eliseo-studio.firebasestorage.app",
                messagingSenderId: "44736873644",
                appId: "1:44736873644:web:917beff23d8c61c3af8b09",
                measurementId: "G-WY0B4DTVMZ"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : "eliseo-studio-v1"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentEditingId = null;
        let pendingDeleteData = null;
        let user = null;

        // SECURITY: Managed Authentication Flow
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
        });

        window.checkKey = async () => {
            // SECURITY: Check key locally, then await Auth before starting listeners
            if (document.getElementById('pass-input').value === "2025") {
                try {
                    await initAuth();
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('main-content').classList.remove('hidden');
                    startListeners();
                } catch (e) { console.error("Auth Failed:", e); }
            }
        };

        function startListeners() {
            // SECURITY GUARD: Ensure User Auth
            if (!auth.currentUser) return;

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), (snap) => {
                let data = [];
                snap.forEach(d => data.push({id: d.id, ...d.data()}));
                document.getElementById('lead-count').innerText = data.length;
                renderLeads(data);
            }, (err) => console.error("Leads Listener Fail:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), (snap) => {
                let data = [];
                snap.forEach(d => data.push({id: d.id, ...d.data()}));
                window.cachedProjects = data;
                document.getElementById('proj-count').innerText = data.length;
                renderProjects(data);
            }, (err) => console.error("Projects Listener Fail:", err));
        }

        // --- Módulo de Eliminación ---
        window.openDeleteModal = (id, type) => {
            pendingDeleteData = { id, type };
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            document.getElementById('delete-modal').classList.add('hidden');
            pendingDeleteData = null;
        };

        document.getElementById('confirm-delete-btn').onclick = async () => {
            if (!pendingDeleteData || !auth.currentUser) return;
            const { id, type } = pendingDeleteData;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id));
                window.closeDeleteModal();
            } catch (e) { console.error("Delete Fail:", e); }
        };

        window.convertToProject = async (leadId) => {
            if (!auth.currentUser) return;
            const lead = window.cachedLeads.find(l => l.id === leadId);
            if (!lead) return;
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'projects', leadId);
                await setDoc(ref, {
                    clientName: lead.name, contact: lead.contact, status: 'active',
                    progress: 10, metrics: { visits: 0, leads: 0 }, 
                    niche: lead.niche, originalBrief: lead.desc, aiProtocol: lead.aiOutput || null
                });
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', leadId));
            } catch(e) { console.error("Convert Fail:", e); }
        };

        window.updateStatus = async (pid, s) => {
            if (!auth.currentUser) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', pid), { status: s });
        };

        window.openMetricsModal = (pid) => {
            currentEditingId = pid;
            const p = window.cachedProjects.find(x => x.id === pid);
            document.getElementById('m-visits').value = p.metrics?.visits || 0;
            document.getElementById('m-leads').value = p.metrics?.leads || 0;
            document.getElementById('m-progress').value = p.progress || 0;
            document.getElementById('metrics-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('metrics-modal').classList.add('hidden');

        document.getElementById('save-metrics-btn').onclick = async () => {
            if (!auth.currentUser) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'projects', currentEditingId);
            await updateDoc(ref, {
                'metrics.visits': parseInt(document.getElementById('m-visits').value),
                'metrics.leads': parseInt(document.getElementById('m-leads').value),
                progress: parseInt(document.getElementById('m-progress').value)
            });
            window.closeModal();
        };

        function renderLeads(leads) {
            window.cachedLeads = leads;
            const container = document.getElementById('leads-list');
            container.innerHTML = '';
            leads.forEach(l => {
                const wa = `https://wa.me/${(l.contact || '').replace(/\D/g,'')}`;
                let stepsHtml = '';
                try {
                    if (l.aiOutput) {
                        const roadmap = JSON.parse(l.aiOutput);
                        stepsHtml = roadmap.steps.map((s, idx) => `
                            <div class="bg-white/[0.01] border border-white/5 p-3 rounded-xl space-y-1">
                                <p class="text-[7px] font-bold uppercase opacity-30">Fase 0${idx+1}</p>
                                <h5 class="text-[10px] font-bold text-white/80">${s.title}</h5>
                                <p class="text-[9px] text-gray-600 leading-tight">${s.details || s.description || ''}</p>
                                <div class="mt-1 bg-green-500/5 p-2 rounded-lg"><p class="text-[8px] text-green-400/60 font-medium line-clamp-1">${s.benefits || 'Optimización'}</p></div>
                            </div>
                        `).join('');
                    }
                } catch(e) { stepsHtml = '<p class="text-[9px] text-red-500/30">Data corrupta</p>'; }

                container.innerHTML += `
                    <div class="glass-card p-4 flex flex-col gap-4 border border-white/5">
                        <div class="flex justify-between items-center">
                            <div><h4 class="text-md font-bold text-white tracking-tighter">${l.name}</h4><p class="text-[8px] text-blue-500 font-bold uppercase tracking-widest">${l.niche}</p></div>
                            <div class="flex gap-2">
                                <button onclick="window.openDeleteModal('${l.id}', 'leads')" class="btn-action btn-delete p-2"><i class="fa-solid fa-trash-can text-xs"></i></button>
                                <a href="${wa}" target="_blank" class="w-9 h-9 rounded-full border border-white/5 flex items-center justify-center hover:bg-[#25d366] transition-all"><i class="fa-brands fa-whatsapp text-sm"></i></a>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="space-y-1"><p class="text-[7px] text-white/20 uppercase font-black tracking-widest">Brief</p><div class="bg-white/[0.01] p-3 rounded-lg"><p class="text-[10px] text-gray-500 italic">"${l.desc}"</p></div></div>
                            <div class="space-y-1"><p class="text-[7px] text-white/20 uppercase font-black tracking-widest">Pulse IA</p><div class="grid grid-cols-2 gap-1 overflow-y-auto max-h-[140px] pr-1">${stepsHtml}</div></div>
                        </div>
                        <button onclick="window.convertToProject('${l.id}')" class="w-full py-3 bg-white text-black rounded-lg text-[8px] font-black uppercase tracking-widest active:scale-[0.98] transition-all">Activar Arquitectura</button>
                    </div>`;
            });
        }

        function renderProjects(projects) {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';
            projects.forEach(p => {
                const colors = { active: 'bg-green-500', suspended: 'bg-red-500', maintenance: 'bg-gray-500' };
                container.innerHTML += `
                    <div class="glass-card p-5 space-y-3 group border border-white/5">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2"><div class="pulse-dot ${colors[p.status]}"></div><h4 class="text-xs font-semibold text-white truncate max-w-[100px]">${p.clientName}</h4></div>
                            <div class="flex gap-1">
                                <button onclick="window.openDeleteModal('${p.id}', 'projects')" class="w-7 h-7 rounded-full border border-white/5 flex items-center justify-center opacity-0 group-hover:opacity-100 btn-delete transition-all"><i class="fa-solid fa-trash-can text-[9px]"></i></button>
                                <button onclick="window.openMetricsModal('${p.id}')" class="w-7 h-7 rounded-full border border-white/5 flex items-center justify-center hover:bg-white hover:text-black transition-all"><i class="fa-solid fa-pen-to-square text-[8px]"></i></button>
                                <a href="https://wa.me/${(p.contact || '').replace(/\D/g,'')}" target="_blank" class="w-7 h-7 rounded-full border border-white/5 flex items-center justify-center hover:bg-[#25d366] transition-all"><i class="fa-brands fa-whatsapp text-[9px]"></i></a>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-1 border-y border-white/5 py-3 text-center">
                            <div><p class="text-[6px] text-gray-700 uppercase font-bold">Vst</p><p class="text-md font-light">${p.metrics?.visits || 0}</p></div>
                            <div><p class="text-[6px] text-gray-700 uppercase font-bold">Lds</p><p class="text-md font-light">${p.metrics?.leads || 0}</p></div>
                            <div><p class="text-[6px] text-gray-700 uppercase font-bold">Prg</p><p class="text-md font-light">${p.progress}%</p></div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="window.updateStatus('${p.id}', 'active')" class="status-btn ${p.status === 'active' ? 'active-green' : ''}">Act</button>
                            <button onclick="window.updateStatus('${p.id}', 'suspended')" class="status-btn ${p.status === 'suspended' ? 'active-red' : ''}">Susp</button>
                            <button onclick="window.updateStatus('${p.id}', 'maintenance')" class="status-btn ${p.status === 'maintenance' ? 'active-gray' : ''}">Mant</button>
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>